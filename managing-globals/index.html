<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Let us assume a CompiledMethod is referenced from the graph to serialize. Sometimes we may be interested in storing just the selector and name of the class, because we know it will be present when materializing the graph. However, sometimes we want to really store the method with full detail.This means that given an object graph, there is not an unique way of serializing it. Fuel offers dynamic and static mechanisms to customize this."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content><meta property="og:description" content="Let us assume a CompiledMethod is referenced from the graph to serialize. Sometimes we may be interested in storing just the selector and name of the class, because we know it will be present when materializing the graph. However, sometimes we want to really store the method with full detail.This means that given an object graph, there is not an unique way of serializing it. Fuel offers dynamic and static mechanisms to customize this."><meta property="og:type" content="article"><meta property="og:url" content="https://theseion.github.io/Fuel/managing-globals/"><meta property="article:section" content><meta property="article:modified_time" content="2021-06-11T12:45:53+02:00"><title>Managing Globals | Fuel</title><link rel=manifest href=/Fuel/manifest.json><link rel=icon href=/Fuel/favicon.png type=image/x-icon><link rel=stylesheet href=/Fuel/book.min.4161ce72491bec8afb94acd3b81e1480e4774aca5e9e3e25c4eeeb0a4dff856a.css integrity="sha256-QWHOckkb7Ir7lKzTuB4UgOR3Sspenj4lxO7rCk3/hWo=" crossorigin=anonymous><script defer src=/Fuel/flexsearch.min.js></script>
<script defer src=/Fuel/en.search.min.003fdbc58be7d1ea976e67132bd82c1ad8b8a718aaaf4adb2e2c2287bb26abd9.js integrity="sha256-AD/bxYvn0eqXbmcTK9gsGti4pxiqr0rbLiwih7smq9k=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a href=/Fuel/><img src=/Fuel/logo-fuel-header.png alt=Logo><span>Fuel</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=https://theseion.github.io/Fuel/builtin-header-support/>Builtin Header Support</a></li><li><a href=https://theseion.github.io/Fuel/customizing-the-graph/>Customizing the Graph</a></li><li><a href=https://theseion.github.io/Fuel/debugging/>Debugging</a></li><li><a href=https://theseion.github.io/Fuel/errors/>Errors</a></li><li><a href=https://theseion.github.io/Fuel/format-migration/>Format Migration</a></li><li><a href=https://theseion.github.io/Fuel/managing-globals/ class=active>Managing Globals</a></li><li><a href=https://theseion.github.io/Fuel/migration/>Migration</a></li><li><a href=https://theseion.github.io/Fuel/package-overview/>Package Overview</a></li><li><span>Releases</span><ul><li><a href=https://theseion.github.io/Fuel/releases/5.1.0/>5.1.0</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.6/>5.0.6</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.5/>5.0.5</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.3/>5.0.3</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.4/>5.0.4</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.2/>5.0.2</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.1/>5.0.1</a></li><li><a href=https://theseion.github.io/Fuel/releases/5.0.0/>5.0.0</a></li><li><a href=https://theseion.github.io/Fuel/releases/4.1.1/>4.1.1</a></li><li><a href=https://theseion.github.io/Fuel/releases/4.1.0/>4.1.0</a></li><li><a href=https://theseion.github.io/Fuel/releases/4.0.0/>4.0.0</a></li><li><a href=https://theseion.github.io/Fuel/releases/3.0.0/>3.0.0</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.9.3/>1.9.3</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.9/>1.9</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.8/>1.8</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.8.1/>1.8.1</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.7/>1.7</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.6/>1.6</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.5/>1.5</a></li><li><a href=https://theseion.github.io/Fuel/releases/1.4/>1.4</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/Fuel/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Managing Globals</strong>
<label for=toc-control><img src=/Fuel/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#default-globals>Default globals</a></li></ul></nav></aside></header><article class=markdown><p>Let us assume a CompiledMethod is referenced from the graph to serialize. Sometimes we may be interested in storing just the selector and name of the class, because we know it will be present when materializing the graph. However, sometimes we want to really store the method with full detail.This means that given an object graph, there is not an unique way of serializing it. Fuel offers dynamic and static mechanisms to customize this.</p><h2 id=default-globals>Default globals
<a class=anchor href=#default-globals>#</a></h2><p>By default, Fuel considers following objects as globals, i.e. will store just its name:</p><ul><li><code>nil</code>, <code>true</code>, <code>false</code>, and <code>Smalltalk globals</code>.</li><li>Any <code>Class</code>, <code>Trait</code>, <code>Metaclass</code> or <code>ClassTrait</code>.</li><li>Any <code>CompiledMethod</code> (except when either it <code>#isInstalled</code> not or <code>#isDoIt</code>, for example, the code is evaluated from Workspace).</li><li>Some well-known global variables: <code>Smalltalk</code> <code>SourceFiles</code> <code>Transcript</code> <code>Undeclared</code> <code>Display</code> <code>TextConstants</code> <code>ActiveWorld</code> <code>ActiveHand</code> <code>ActiveEvent</code> <code>Sensor</code> <code>Processor</code> <code>ImageImports</code> <code>SystemOrganization</code> <code>World</code>.
Custom globals are duplicated
In this following code snippet we show that by default the global value is not serialized as a global, and so it is duplicated on materialization.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-smalltalk data-lang=smalltalk><span style=display:flex><span> <span style=color:#75715e>&#34;Define a global variable named #SomeGlobal.&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>SomeGlobal</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Set</span> new.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Serialize and materialize the value of #SomeGlobal.&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>FLSerializer</span> 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>serialize:</span> <span style=color:#a6e22e>SomeGlobal</span> 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>toFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span>.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;The materialized object *is not* the same as the global instance.&#34;</span>
</span></span><span style=display:flex><span> [ (<span style=color:#a6e22e>FLMaterializer</span> <span style=color:#a6e22e>materializeFromFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span>) <span style=color:#a6e22e>~~</span> <span style=color:#a6e22e>SomeGlobal</span> ] <span style=color:#a6e22e>assert</span>.
</span></span></code></pre></div><p>But&mldr;
How to avoid duplication
Instead, in the code below <code>#considerGlobal:</code> is used to specify that it should be stored as global.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-smalltalk data-lang=smalltalk><span style=display:flex><span> <span style=color:#f92672>|</span> aSerializer <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Define a global variable named #SomeGlobal.&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>SomeGlobal</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Set</span> new.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> aSerializer <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FLSerializer</span> <span style=color:#a6e22e>newDefault</span>.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Tell the serializer to consider #SomeGlobal as global.&#34;</span>
</span></span><span style=display:flex><span> aSerializer <span style=color:#a6e22e>analyzer</span> <span style=color:#a6e22e>considerGlobal:</span> <span style=color:#e6db74>#SomeGlobal</span>.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> aSerializer 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>serialize:</span> <span style=color:#a6e22e>SomeGlobal</span> 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>toFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span>.
</span></span><span style=display:flex><span> 	
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;In this case, the materialized object *is* the same as the global instance.&#34;</span>
</span></span><span style=display:flex><span> [ (<span style=color:#a6e22e>FLMaterializer</span> <span style=color:#a6e22e>materializeFromFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span>) <span style=color:#a6e22e>==</span> <span style=color:#a6e22e>SomeGlobal</span> ] <span style=color:#a6e22e>assert</span>.
</span></span></code></pre></div><p>This feature is tested in tests-globals protocol of <code>FLBasicSerializationTest</code> as well in <code>FLGlobalEnvironmentTest</code>.
Changing the environment
It is possible to specify where the global will be looked-up during materialization. The method <code>#globalEnvironment:</code> exists for that purpose, as the following example shows.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-smalltalk data-lang=smalltalk><span style=display:flex><span> <span style=color:#f92672>|</span> aSerializer aMaterializer anEnvironment <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Define a global variable named #SomeGlobal.&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>SomeGlobal</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Set</span> new.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Tell the serializer to consider #SomeGlobal as global.&#34;</span>
</span></span><span style=display:flex><span> aSerializer <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FLSerializer</span> <span style=color:#a6e22e>newDefault</span>.
</span></span><span style=display:flex><span> aSerializer <span style=color:#a6e22e>analyzer</span> <span style=color:#a6e22e>considerGlobal:</span> <span style=color:#e6db74>#SomeGlobal</span>.
</span></span><span style=display:flex><span> aSerializer 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>serialize:</span> <span style=color:#a6e22e>SomeGlobal</span> 
</span></span><span style=display:flex><span> 	<span style=color:#a6e22e>toFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span>.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;Override value for #SomeGlobal.&#34;</span>
</span></span><span style=display:flex><span> anEnvironment <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Dictionary</span> <span style=color:#a6e22e>newFrom:</span> <span style=color:#a6e22e>Smalltalk</span> <span style=color:#a6e22e>globals</span>.
</span></span><span style=display:flex><span> anEnvironment <span style=color:#a6e22e>at:</span> <span style=color:#e6db74>#SomeGlobal</span> <span style=color:#a6e22e>put:</span> {<span style=color:#ae81ff>42</span>}.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>&#34;In this case, the materialized object *is the same* as the global instance.&#34;</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>FileStream</span> <span style=color:#a6e22e>oldFileNamed:</span> <span style=color:#e6db74>&#39;g.fuel&#39;</span> <span style=color:#a6e22e>do:</span> [ <span style=color:#f92672>:</span>aStream <span style=color:#f92672>|</span>
</span></span><span style=display:flex><span> 	aStream <span style=color:#a6e22e>binary</span>.
</span></span><span style=display:flex><span> 	aMaterializer <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FLMaterializer</span> <span style=color:#a6e22e>newDefault</span>.
</span></span><span style=display:flex><span> 	
</span></span><span style=display:flex><span> 	<span style=color:#75715e>&#34;Set the environment&#34;</span>
</span></span><span style=display:flex><span> 	aMaterializer <span style=color:#a6e22e>globalEnvironment:</span> anEnvironment.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> 	[ (aMaterializer <span style=color:#a6e22e>materializeFrom:</span> aStream) <span style=color:#a6e22e>root</span> <span style=color:#a6e22e>=</span> {<span style=color:#ae81ff>42</span>} ] <span style=color:#a6e22e>assert</span> ]
</span></span></code></pre></div><p>This feature is tested in the class <code>FLGlobalEnvironmentTest</code>. The global environment can be setted also for serialization (not only materialization), but we don&rsquo;t include an example for that case.
Let us assume a CompiledMethod is referenced from the graph to serialize. Sometimes we may be interested in storing just the selector and name of the class, because we know it will be present when materializing the graph. However, sometimes we want to really store the method with full detail.</p><p>This means that given an object graph, there is not an unique way of serializing it. Fuel offers dynamic and static mechanisms to customize this.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/theseion/Fuel/commit/30f646158dec95bc10995c12d702a06ef16da709 title='Last modified by Max Leske | Jun 11, 2021' target=_blank rel=noopener><img src=/Fuel/svg/calendar.svg class=book-icon alt=Calendar>
<span>Jun 11, 2021</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#default-globals>Default globals</a></li></ul></nav></div></aside></main></body></html>